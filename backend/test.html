<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECharts 知识图谱可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #main {
            width: 100%;
            height: 95vh; /* Increased height */
            min-height: 500px; /* Minimum height */
            border: 1px solid #eee;
            box-sizing: border-box; /* Include border in size */
        }
        h1 {
            text-align: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <h1>知识图谱可视化</h1>

    <div id="main"></div>

    <script type="text/javascript">
        var chartDom = document.getElementById('main');
        var myChart = echarts.init(chartDom);
        var option;

        // --- 配置 ---
        // *** 重要：请将 '/api/graph/initial/' 替换为你实际的 Django API 端点 URL ***
        const apiUrl = 'http://127.0.0.1:8000/api/graph/initial/';
        // --- 配置结束 ---

        function loadAndRenderGraph() {
            myChart.showLoading(); // 显示加载动画

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP 错误! 状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(graphData => {
                    myChart.hideLoading(); // 隐藏加载动画

                    if (!graphData || !graphData.nodes || !graphData.links) {
                        console.error("从服务器接收到的数据结构无效:", graphData);
                        alert("错误：从服务器接收到的数据结构无效。");
                        return;
                    }

                    const nodes = graphData.nodes;
                    const links = graphData.links;

                    // --- 去重 Links (根据你的数据样本，似乎有重复的边) ---
                    // 创建一个唯一标识符来检测重复的 links
                    const uniqueLinkIds = new Set();
                    const uniqueLinks = links.filter(link => {
                        // 基于 source, target, 和 type (label) 创建一个 key
                        const linkKey = `${link.source}->${link.target}->${link.label?.formatter || link.type}`;
                        if (!uniqueLinkIds.has(linkKey)) {
                            uniqueLinkIds.add(linkKey);
                            return true;
                        }
                        return false;
                    });
                     console.log(`原始 Links 数量: ${links.length}, 去重后 Links 数量: ${uniqueLinks.length}`);


                    // --- 准备 Categories (用于图例和样式) ---
                    const categoryNames = [...new Set(nodes.map(node => node.category || 'Default'))];
                    const categories = categoryNames.map(name => ({ name: name }));

                    console.log("接收到节点数量:", nodes.length);
                    console.log("去重后边数量:", uniqueLinks.length);
                    console.log("检测到的分类:", categoryNames);

                    // --- ECharts 配置选项 ---
                    option = {
                        title: {
                            text: '反诈骗知识图谱', // 图表标题
                            subtext: '力引导布局',    // 副标题
                            top: 'top',          // 标题位置
                            left: 'center'
                        },
                        tooltip: { // 鼠标悬浮提示框
                            formatter: function (params) {
                                if (params.dataType === 'node') {
                                    // 节点提示框：显示名称、ID、分类和属性
                                    let propsHtml = `<b>${params.data.name}</b> (ID: ${params.data.id})<br/>分类: ${params.data.category}<br/>--- 属性 ---<br/>`;
                                    if (params.data.properties) {
                                        for (const key in params.data.properties) {
                                            // 使用 escapeHTML 防止 XSS
                                            const safeKey = escapeHTML(key);
                                            const safeValue = escapeHTML(params.data.properties[key]);
                                            propsHtml += `${safeKey}: ${safeValue}<br/>`;
                                        }
                                    } else {
                                        propsHtml += "无";
                                    }
                                    return propsHtml;
                                } else if (params.dataType === 'edge') {
                                    // 边提示框：显示类型、源节点和目标节点
                                    let propsHtml = `<b>关系: ${escapeHTML(params.data.type || params.data.label?.formatter)}</b><br/>`;
                                    propsHtml += `源: ${escapeHTML(params.data.source)}<br/>`;
                                    propsHtml += `目标: ${escapeHTML(params.data.target)}<br/>`;
                                    // 如果后端返回了边的属性，也可以在这里显示
                                    // if (params.data.properties && Object.keys(params.data.properties).length > 0) { ... }
                                    return propsHtml;
                                }
                                return ''; // 其他情况不显示
                            }
                        },
                        legend: [{ // 图例组件，显示节点分类
                            data: categories.map(function (a) {
                                return a.name;
                            }),
                            selectedMode: 'multiple', // 'single' 或 'multiple'
                            top: 'bottom',
                            left: 'center',
                            orient: 'horizontal' // 'vertical' 或 'horizontal'
                        }],
                        animationDurationUpdate: 1500, // 更新动画时长
                        animationEasingUpdate: 'quinticInOut', // 更新动画缓动效果
                        series: [
                            {
                                name: '知识图谱',        // 系列名称
                                type: 'graph',          // 图表类型：关系图
                                layout: 'force',        // 布局：力引导布局
                                data: nodes,            // 节点数据
                                links: uniqueLinks,     // 边数据 (使用去重后的)
                                categories: categories, // 节点分类
                                roam: true,             // 开启鼠标缩放和平移漫游
                                draggable: true,        // 节点可拖拽
                                label: {                // 节点标签设置
                                    show: true,         // 显示标签
                                    position: 'right',  // 标签位置
                                    formatter: '{b}'    // 标签内容：显示节点名称 ({b} 代表 name)
                                },
                                labelLayout: {          // 标签布局配置 (防止重叠)
                                    hideOverlap: true
                                },
                                scaleLimit: {           // 缩放限制
                                    min: 0.4,
                                    max: 4
                                },
                                lineStyle: {            // 关系边的默认样式
                                    color: '#aaa',      // 颜色
                                    curveness: 0.1,     // 曲度
                                    width: 2            // 线宽
                                },
                                emphasis: {             // 高亮状态配置 (鼠标悬浮时)
                                    focus: 'adjacency', // 高亮相邻节点和边
                                    label: {            // 高亮时标签
                                        show: true,
                                        fontSize: 14
                                    },
                                    lineStyle: {        // 高亮时边的样式
                                        width: 4
                                    }
                                },
                                // 力引导布局配置
                                force: {
                                    repulsion: 100,     // 节点之间的斥力因子
                                    edgeLength: [50, 100], // 边的两个节点之间的距离，值越小则越短
                                    layoutAnimation: true, // 显示布局动画
                                    gravity: 0.1        // 节点受到的向中心的引力因子
                                }
                            }
                        ]
                    };
                    // 应用配置项到图表
                    myChart.setOption(option);

                })
                .catch(error => {
                    myChart.hideLoading(); // 出错也要隐藏加载
                    console.error('加载图表数据时出错:', error);
                    alert(`加载图表数据失败: ${error.message}`);
                });
        }

        // 初始加载图表
        loadAndRenderGraph();

        // 使图表响应窗口大小变化
        window.addEventListener('resize', function () {
            myChart.resize();
        });

        // 简单的 HTML 转义函数，防止 XSS 攻击
        function escapeHTML(str) {
            if (typeof str !== 'string') return str; // 只处理字符串
            return str.replace(/[&<>'"]/g, tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag] || tag));
        }

    </script>
</body>
</html>